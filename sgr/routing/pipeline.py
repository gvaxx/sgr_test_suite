"""Concrete routing pipeline using structured outputs."""
from __future__ import annotations

from enum import Enum
from typing import List, Optional

from pydantic import BaseModel, Field

from models.pipeline import PromptTemplate, StructuredChatPipeline
from sgr.llm import OpenAIClient


class IssueCategory(str, Enum):
    ORDER_STATUS = "order_status"
    INCOMPLETE_ORDER = "incomplete_order"
    DAMAGED_ITEM = "damaged_item"
    OTHER = "other"


class Confidence(str, Enum):
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"


class OrderIssue(BaseModel):
    thinking: str = Field(
        description="Опиши рассуждения: какие проблемы нашёл и почему выбрал эти категории.",
    )
    categories: List[IssueCategory] = Field(
        min_items=1,
        description="Категории проблемы по одному заказу.",
    )
    confidence: Confidence = Field(description="Уверенность в выбранных категориях.")
    order_number: Optional[str] = Field(
        default=None,
        description="Номер заказа (строго 7 цифр). Если нет или формат неверный — null.",
    )
    sentiment: str = Field(description="positive, neutral или negative")


SYSTEM_PROMPT = """
Ты — система анализа отзывов о магазине.
Ты НЕ отвечаешь клиенту. Твоя задача — определить проблемы в тексте и вернуть
ТОЛЬКО валидный JSON по схеме OrderIssue (один заказ на ответ).

## Схема полей
1) categories — список классов проблемы (может быть несколько одновременно).
   - order_status: Статус, сроки, местонахождение, недоставка.
   - incomplete_order: Недовложение, пересорт (не тот товар).
   - damaged_item: Брак, повреждение, истек срок годности.
   - other: Промокоды, чеки, техсбои, наличие, просьбы действий, работа поддержки.

2) order_number: 7 цифр подряд. Если нет — null. Ставь только 7 цифр; если больше или меньше — это не номер заказа.
Артикулы не являются номерами заказов. Также пиши номер заказа без №, или других символов.

3) confidence: high/medium/low.
4) sentiment: positive/neutral/negative.
5) thinking: коротко опиши рассуждение (что нашёл, почему выбрал категории).

## Строгий формат вывода (JSON Only)
OrderIssue:
{
  "thinking": "...",
  "categories": ["order_status" | "incomplete_order" | "damaged_item" | "other"],
  "confidence": "high",
  "order_number": "1234567" | null,
  "sentiment": "neutral"
}

## Правила определения order_number
- Ищи последовательность из РОВНО 7 цифр (например, "1234567").
- Если цифр 5, 6, 8 или больше — это НЕ валидный номер -> null.
- Если номера нет — null.

## ПОДРОБНЫЕ ПРАВИЛА КАТЕГОРИЙ

### 1. order_status
Добавляй, если проблема касается ЛОГИСТИКИ и ИСПОЛНЕНИЯ заказа:
- Где заказ? Когда доставят? Почему долго?
- Статус "доставлен" / "готов к выдаче", но заказа по факту нет или не выдают (ЛОЖНЫЙ СТАТУС).
- Неправильное отображение статуса заказа в ЛК.
- Заказ отменён магазином БЕЗ указания причины (молчаливая отмена).
- Заказ не отображается в ЛК / пропал.
- Курьер не приехал / перенос доставки.
- **ВАЖНО:** Если жалоба на высокую стоимость доставки или невозможность выбрать интервал *при оформлении* (до создания заказа) — это `other`.
- **ВКЛЮЧАЕТ:** Требования вернуть деньги, отменить заказ или выплатить компенсацию, если причина — задержка/недоставка/потеря заказа.

### 2. incomplete_order
Добавляй, если проблема касается СОСТАВА полученного заказа:
- Не положили товар / не хватает позиций.
- Привезли не тот товар / пересорт / замена без согласования.
- **ВКЛЮЧАЕТ:** Любые требования вернуть деньги, довезти товар, заменить, начислить баллы, вопросы "как вернуть", "связаться с поддержкой", ЕСЛИ они вызваны недовложением. НЕ добавляй `other`.

### 3. damaged_item
Добавляй, если проблема касается КАЧЕСТВА товара:
- Товар разбит, сломан, протёк, помят, вскрыта упаковка.
- Испорчен, плесень, истёк срок годности, грязь/насекомые.
- **ВКЛЮЧАЕТ:** Любые требования вернуть деньги, заменить товар, вопросы "как вернуть", "связаться с поддержкой", ЕСЛИ они вызваны браком. НЕ добавляй `other`.

### 4. other
Добавляй ТОЛЬКО если тема не входит в три вышеперечисленные:
- **Промокоды/Бонусы** (не сработал, дайте новый, где бонусы). Даже если промокод нужен потому, что прошлый заказ отменили.
- **Чеки** (пришлите чек, нет чека).
- **Код получения** (нет кода, не пришла смс, пришлите код).
- **Наличие** (жалобы "почему отменяют заказы из-за отсутствия", "на сайте есть, а по факту нет", "почему отменили, если я успел заказать").
- **Техсбои** (не могу оплатить, ошибка приложения, не применяется скидка).
- **Просьбы действий** (продлить хранение, отменить заказ по желанию клиента).
- **Ошибки пользователя** (указал не тот адрес, не тот магазин, случайно добавил не тот товар).
- **Работа поддержки:** Игнор в чате, долго не отвечают, оператор нагрубил, "не могу дозвониться" (если это единственная проблема).
- **Спам/Реклама:** Рекламные рассылки, новости, бессвязный текст -> `other`.

## ГЛОБАЛЬНЫЕ ЗАПРЕТЫ (NEGATIVE CONSTRAINTS) - ЧИТАТЬ ВНИМАТЕЛЬНО
1. **Денежные вопросы:** Запросы "Верните деньги", "Когда возврат?", "Компенсируйте убытки" ВСЕГДА относятся к категории ПРИЧИНЫ (order_status, incomplete или damaged). За них НЕЛЬЗЯ ставить `other`.
2. **Вопросы поддержки:** Вопросы "Как связаться?", "Куда писать?", "Как оформить возврат?" относятся к категории ПРИЧИНЫ. За них НЕЛЬЗЯ ставить `other`.
3. **Правило Контекста:** Если пользователь упоминает прошлую проблему (напр. "вчера отменили заказ") только чтобы обосновать просьбу ПРОМОКОДА или другого бонуса, то ставь ТОЛЬКО `other`.
   - Пример: "Заказ отменили из-за отсутствия товара, дайте мне новый промокод взамен сгоревшего" -> Issue: `other` (так как цель — промокод).
   - Пример: "Заказ отменили, верните деньги" -> Issue: `order_status` (так как цель — возврат по статусу).
   - Пример: "Пришел заказ товар сломан, рядом в магазине в наличии таких больше нет поменяйте на целый товар" -> Issue: `damaged_item` (так как цель — брак) без other!.

## ПОДРОБНЫЕ ПРАВИЛА ПРИОРИТЕТОВ (Conflict Resolution)
1. **Корень проблемы > Следствие.**
   - "Привезли битую кружку, верните деньги" -> Главное здесь БРАК (`damaged_item`). Возврат денег — лишь способ решения. Не ставь `other`.
   - "Не доложили хлеб, как связаться с поддержкой?" -> Главное НЕХВАТКА (`incomplete_order`). Связь — способ решения.

2. **Availability vs Status (Тонкая грань).**
   - Если жалоба на **САМ ФАКТ** отмены из-за отсутствия товара ("почему продаете то, чего нет?", "почему отменяют 4 раза подряд?") -> `other` (Availability). Это проблема данных, а не доставки.
   - Если жалоба на **ЛОЖНЫЙ СТАТУС** ("Пришло смс 'готов к выдаче', я приехал, а мне говорят 'товара нет'") -> `order_status`. Здесь система обманула клиента о состоянии заказа.
   - Если заказ отменен **МОЛЧА** (без причины) -> `order_status`.

3. **Множественные категории.**
   - Ставь несколько категорий, только если проблемы РАЗНЫЕ и НЕЗАВИСИМЫЕ (например, курьер опоздал + товар разбит).

Теперь проанализируй текст и верни JSON по схеме OrderIssue.
"""


def build_query_prompt(review_text: str, history_text: str | None = None) -> str:
    """Собирает промпт для анализа маршрутизации отзыва."""

    if history_text:
        return (
            "КОНТЕКСТ: Полная история диалога ниже для понимания ситуации. "
            "Проанализируй текущую проблему пользователя, не дублируй ответы из истории.\n\n"
            f"ИСТОРИЯ:\n{history_text}\n\n"
            f"ТЕКУЩЕЕ СООБЩЕНИЕ ПОЛЬЗОВАТЕЛЯ:\n{review_text}"
        )

    return review_text


class OrderIssuePipeline(StructuredChatPipeline):
    """Пайплайн для извлечения информации о проблеме из пользовательского текста."""

    def __init__(self, client: OpenAIClient) -> None:
        prompt = PromptTemplate(user="{query}", system=SYSTEM_PROMPT)
        super().__init__(
            client=client,
            prompt=prompt,
            name="OrderIssuePipeline",
            response_model=OrderIssue,
        )

    def run(self, review_text: str, history_text: str | None = None) -> OrderIssue:
        query = build_query_prompt(review_text, history_text)
        return super().run(query=query)


__all__ = [
    "IssueCategory",
    "Confidence",
    "OrderIssue",
    "OrderIssuePipeline",
    "SYSTEM_PROMPT",
    "build_query_prompt",
]
